<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-03-31 Tue 07:32 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Minimization/maximization of functions</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="John Kitchin" />
<meta name="keywords" content="scipy.optimize.minimize" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Minimization/maximization of functions</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga55d8d4">1. Function extrema</a>
<ul>
<li><a href="#org4bebca9">1.1. Find the derivative, and solve for where it is zero</a></li>
<li><a href="#org66a40f3">1.2. Newton-Raphson method of minima finding</a></li>
</ul>
</li>
<li><a href="#org8d30db7">2. scipy.optimize.minimize</a>
<ul>
<li><a href="#orga25baea">2.1. Multiple minima</a></li>
<li><a href="#org440ee7e">2.2. Finding maxima</a></li>
<li><a href="#org7b784b6">2.3. Application to maximizing profit in a PFR</a></li>
</ul>
</li>
<li><a href="#orgcb14ac9">3. Summary</a></li>
</ul>
</div>
</div>

<div id="outline-container-orga55d8d4" class="outline-2">
<h2 id="orga55d8d4"><span class="section-number-2">1</span> Function extrema</h2>
<div class="outline-text-2" id="text-1">
<p>
It is pretty common to need to find extreme values of a function in engineering analysis. An extreme value is often a maximum or minimum in a function, and we seek them when we want to maximize a profit function, or minimize a cost function, identify a maximum safe operating condition, etc.
</p>

<p>
Let's consider an example function with a graphical solution approach. We want a quantitative estimate of the minimum in this function.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
%matplotlib inline
<span style="color: #0000FF;">import</span> matplotlib.pyplot <span style="color: #0000FF;">as</span> plt

<span style="color: #0000FF;">def</span> <span style="color: #006699;">f</span>(x):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> x**2 + np.exp(-5 * x**2)

<span style="color: #BA36A5;">x</span> = np.linspace(0, 2)
<span style="color: #BA36A5;">y</span> = f(x)
plt.plot(x, y)
</pre>
</div>

<pre class="example">
[&lt;matplotlib.lines.Line2D at 0x11aaa15d0&gt;]
</pre>


<pre class="example">
&lt;Figure size 432x288 with 1 Axes&gt;
</pre>



<div class="figure">
<p><img src="obipy-resources/c32ed400013180969dbb2fb32c999750492e428a/a34b747c1c136c312d04acc182eb110f10246172.png" alt="a34b747c1c136c312d04acc182eb110f10246172.png" />
</p>
</div>

<p>
You can see there is a minimum near 0.6. We can find the minimum in a crude kind of way by finding the index of the minimum value in the y-array, and then getting the corresponding value of the x-array. You control the accuracy of this answer by the number of points you discretize the function over.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #BA36A5;">x</span> = np.linspace(0, 2, 50)
<span style="color: #BA36A5;">y</span> = f(x)
<span style="color: #BA36A5;">i</span> = np.argmin(y)
x[i]
</pre>
</div>

<pre class="example">
0.5714285714285714
</pre>

<p>
What are the pros and cons of this method:
</p>

<p>
Pros:
</p>
<ol class="org-ol">
<li>It is <i>easy</i>.</li>
<li>You <i>see</i> the whole domain you are looking at, and it is easy to see how many extrema their are</li>
</ol>

<p>
Cons:
</p>
<ol class="org-ol">
<li><i>Lot's</i> of function evaluations. Imagine if it took a long time to compute each value.</li>
<li>Somewhat tedious.</li>
<li>Not so easy to reproduce</li>
<li>Not scalable to large problems, your time to do this becomes a limiting factor.</li>
</ol>
</div>

<div id="outline-container-org4bebca9" class="outline-3">
<h3 id="org4bebca9"><span class="section-number-3">1.1</span> Find the derivative, and solve for where it is zero</h3>
<div class="outline-text-3" id="text-1-1">
<p>
We can also derive the first derivative:
</p>

<p>
\(y' = 2 * x + e^{-5 x^2} (-10 * x)\)
</p>

<p>
and solve it for zero using fsolve.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">def</span> <span style="color: #006699;">yp</span>(x):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> 2 * x + np.exp(-5 * x**2) * (-10 * x)

<span style="color: #0000FF;">from</span> scipy.optimize <span style="color: #0000FF;">import</span> fsolve
fsolve(yp, 0.5)
</pre>
</div>

<pre class="example">
array([0.56735137])
</pre>

<p>
These two answer agree to 5 decimal places.
</p>

<p>
This depends on your ability to correctly derive and implement the derivative. It is good to know you can solve this problem by more than one method. Here, we use a numerical derivative in the function instead to check our derivative. You can check the convergence of the derivative by varying the dx.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">from</span> scipy.misc <span style="color: #0000FF;">import</span> derivative

<span style="color: #0000FF;">def</span> <span style="color: #006699;">ypd</span>(x):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> derivative(f, x, dx=1e-6)

fsolve(ypd, 0.5)
</pre>
</div>

<pre class="example">
array([0.56735137])
</pre>

<p>
These look the same within tolerance. This is not a beautiful solution, but it is hard to argue with success here!
</p>
</div>
</div>

<div id="outline-container-org66a40f3" class="outline-3">
<h3 id="org66a40f3"><span class="section-number-3">1.2</span> Newton-Raphson method of minima finding</h3>
<div class="outline-text-3" id="text-1-2">
<p>
To use the Newton-Raphson method to get the minimum, we use an iterative approach with:
</p>

<p>
\(x_{n+1} = x_n - \frac{y'(x_n)}{y''(x_n)}\).
</p>

<p>
We have to derive these formulas if you want to use analytical derivatives:
</p>

<p>
\(y' = 2 * x + e^{-5 x^2} (-10 * x)\)
</p>

<p>
\(y'' = 2 + e^{-5 x^2} (-10 * x)^2 - 10 e^{-5 x^2}\)
</p>

<p>
Alternatively, we can estimate the derivatives numerically using <code>scipy.misc.derivative</code>. This has the downside of numerical instability for dx that is too small, or low accuracy if it is too large, and the need to check if you made a good choice for it. On the plus side, it avoids making mistakes in the derivative derivation and implementation.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">from</span> scipy.misc <span style="color: #0000FF;">import</span> derivative

<span style="color: #BA36A5;">x0</span> = 0.2
<span style="color: #BA36A5;">f0</span> = f(x0)

<span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">range</span>(15):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">yp</span> = derivative(f, x0, dx=1e-6, n=1)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">ypp</span> = derivative(f, x0, dx=1e-6, n=2)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">xnew</span> = x0 - yp / ypp
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">fnew</span> = f(xnew)

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">if</span> np.<span style="color: #006FE0;">abs</span>(yp) &lt;= 1e-6:
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">break</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">x0</span> = xnew
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">f0</span> = fnew


xnew, fnew, yp, i
</pre>
</div>

<pre class="example">
(0.5673513747965597, 0.5218875824868201, 3.3306690738754696e-10, 5)
</pre>

<p>
This answer also agrees to at least 5 decimal places. This is the gist of what happens in fsolve.
</p>

<p>
As we have seen many times, finding minima is such a common task that there are dedicated functions available for doing it. One of the is <code>scipy.optimize.fmin</code>. This has a similar signature as <code>scipy.optimize.fsolve</code>, you give it a function and an initial guess, and it iteratively searches for a minimum.
</p>
</div>
</div>
</div>

<div id="outline-container-org8d30db7" class="outline-2">
<h2 id="org8d30db7"><span class="section-number-2">2</span> scipy.optimize.minimize</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">from</span> scipy.optimize <span style="color: #0000FF;">import</span> minimize
minimize?
</pre>
</div>

<p>
Here is the basic use of fmin. As always, we should plot the answer where feasible to make sure it is the minimum we wanted.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">def</span> <span style="color: #006699;">f</span>(x):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> x**2 + np.exp(-5 * x**2)

<span style="color: #BA36A5;">guess</span> = 0.5
<span style="color: #BA36A5;">sol</span> = minimize(f, guess)
sol
</pre>
</div>

<pre class="example">
     fun: 0.5218875824868201
hess_inv: array([[0.15524504]])
     jac: array([4.47034836e-08])
 message: 'Optimization terminated successfully.'
    nfev: 15
     nit: 3
    njev: 5
  status: 0
 success: True
       x: array([0.56735137])
</pre>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #BA36A5;">x</span> = np.linspace(0, 2)
<span style="color: #BA36A5;">y</span> = f(x)

plt.plot(x, y, <span style="color: #008000;">'b-'</span>)
plt.plot(sol.x, f(sol.x), <span style="color: #008000;">'ro'</span>)
plt.xlabel(<span style="color: #008000;">'x'</span>)
plt.ylabel(<span style="color: #008000;">'y'</span>)
plt.legend([<span style="color: #008000;">'f(x)'</span>, <span style="color: #008000;">'fmin'</span>])
</pre>
</div>

<pre class="example">
&lt;Figure size 432x288 with 1 Axes&gt;
</pre>



<div class="figure">
<p><img src="obipy-resources/c32ed400013180969dbb2fb32c999750492e428a/7c85430daf445895c21d5f28d9c8121b85ad7d03.png" alt="7c85430daf445895c21d5f28d9c8121b85ad7d03.png" />
</p>
</div>

<p>
Note this answer is only the same in the first 4 decimal places. Remember that these iterative approaches stop when a tolerance is met. Check the defaults on fmin!
</p>
</div>

<div id="outline-container-orga25baea" class="outline-3">
<h3 id="orga25baea"><span class="section-number-3">2.1</span> Multiple minima</h3>
<div class="outline-text-3" id="text-2-1">
<p>
It is possible for functions to have more than one minimum. In this case, your guess will determine which minimum is found. Here is an example where there is a minimum near 2.2, and one near 4.5.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">def</span> <span style="color: #006699;">h</span>(x):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> 2 + np.cos(x) + np.cos(2*x - 0.5) / 2

<span style="color: #BA36A5;">x</span> = np.linspace(0, 2 * np.pi)

plt.plot(x, h(x))
plt.xlabel(<span style="color: #008000;">'x'</span>)
plt.ylabel(<span style="color: #008000;">'h(x)'</span>)
</pre>
</div>

<pre class="example">
Text(0, 0.5, 'h(x)')
</pre>


<pre class="example">
&lt;Figure size 432x288 with 1 Axes&gt;
</pre>



<div class="figure">
<p><img src="obipy-resources/c32ed400013180969dbb2fb32c999750492e428a/caf2389610248e54db282d1143b1ab22f711272a.png" alt="caf2389610248e54db282d1143b1ab22f711272a.png" />
</p>
</div>

<p>
This guess finds the one near 2.2:
</p>

<div class="org-src-container">
<pre class="src src-ipython">minimize(h, 2)
</pre>
</div>

<pre class="example">
     fun: 1.0448871783746694
hess_inv: array([[0.52336689]])
     jac: array([-2.98023224e-08])
 message: 'Optimization terminated successfully.'
    nfev: 15
     nit: 3
    njev: 5
  status: 0
 success: True
       x: array([2.26106174])
</pre>

<p>
and this guess finds the one near 4.5
</p>

<div class="org-src-container">
<pre class="src src-ipython">minimize(h, 4)
</pre>
</div>

<pre class="example">
     fun: 1.4758979742813512
hess_inv: array([[0.94727664]])
     jac: array([-9.08970833e-07])
 message: 'Optimization terminated successfully.'
    nfev: 21
     nit: 5
    njev: 7
  status: 0
 success: True
       x: array([4.35545599])
</pre>

<p>
You have to decide which one is better for the problem at hand. If this were a cost function, the one at the lower cost is probably better! Note that all we can say here is which one is lower in the interval we are looking at. By inspection of the function, you can see it will be periodic, so there will be many other minima that also exist.
</p>
</div>
</div>

<div id="outline-container-org440ee7e" class="outline-3">
<h3 id="org440ee7e"><span class="section-number-3">2.2</span> Finding maxima</h3>
<div class="outline-text-3" id="text-2-2">
<p>
<code>fmin</code> is for finding <i>minima</i>. We can use it to find maxima though, but finding the <i>minima</i> of \(-f(x)\). You can see here that when we plot \(-h(x)\) the minima become maxima, and vice-versa. Now you can see there are two definite minima, one near zero, and one near 3.5, which correspond to the maxima of \(h(x)\).
</p>

<div class="org-src-container">
<pre class="src src-ipython">plt.plot(x, -h(x))
plt.xlabel(<span style="color: #008000;">'x'</span>)
plt.ylabel(<span style="color: #008000;">'-h(x)'</span>)
</pre>
</div>

<pre class="example">
Text(0, 0.5, '-h(x)')
</pre>


<pre class="example">
&lt;Figure size 432x288 with 1 Axes&gt;
</pre>



<div class="figure">
<p><img src="obipy-resources/c32ed400013180969dbb2fb32c999750492e428a/2c4d83dc14a7c7b866c403376bdc62bddbce2659.png" alt="2c4d83dc14a7c7b866c403376bdc62bddbce2659.png" />
</p>
</div>

<p>
The standard way to use fmin is to define an optional argument for the sign that defaults to one. Then, when we call fmin, we will pass -1 as the sign to the function, so we find the minimum of -h(x). Then, we evaluate h(x) at that x-value to get the actual value of the maximum. It is not necessary do this, you can also manually pass around the sign and try to keep it straight.
</p>

<p>
Here is an example to find the maximum near 3.5.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">def</span> <span style="color: #006699;">h</span>(x, sign=1):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> sign * (2 + np.cos(x) + np.cos(2*x - 0.5) / 2)

<span style="color: #BA36A5;">sol</span> = minimize(h, 3.5, args=(-1,))  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">set sign=-1 here to minimize -h(x)</span>
<span style="color: #0000FF;">print</span>(h(sol.x))  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">sign defaults to 1 here, so we get the maximum value</span>

plt.plot(x, h(x))
plt.plot(sol.x, h(sol.x), <span style="color: #008000;">'ro'</span>)
plt.xlabel(<span style="color: #008000;">'x'</span>)
plt.ylabel(<span style="color: #008000;">'h(x)'</span>)
</pre>
</div>

<p>
[1.56120872]
</p>

<pre class="example">
Text(0, 0.5, 'h(x)')
</pre>


<pre class="example">
&lt;Figure size 432x288 with 1 Axes&gt;
</pre>



<div class="figure">
<p><img src="obipy-resources/c32ed400013180969dbb2fb32c999750492e428a/d78494639e0b6ccc4b30efc4862b3ace064baf81.png" alt="d78494639e0b6ccc4b30efc4862b3ace064baf81.png" />
</p>
</div>

<p>
Once again, here you have to decide which maximum is relevant
</p>
</div>
</div>

<div id="outline-container-org7b784b6" class="outline-3">
<h3 id="org7b784b6"><span class="section-number-3">2.3</span> Application to maximizing profit in a PFR</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Compound X with concentration of \(C_{X0} = 2.5\) kmol / m<sup>3</sup> at a flow rate of 12 m<sup>3</sup>/min is converted to Y in a first order reaction with a rate constant of 30 1/min in a tubular reactor. The value of Y is $1.5/kmol. The cost of operation is $2.50 per minute per m<sup>3</sup>. Find the reactor length that maximizes the profit (profit is value of products minus operating costs).
</p>

<p>
First, consider why there is a maximum. At low volumes the operating cost is low, and the production of Y is low. At high volumes, you maximize production of Y, so you have the most value, but the operating costs go up (to infinity for complete conversion!). Somewhere in the middle is where a maximum is.
</p>

<p>
Here are some relevant constants.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #BA36A5;">cost</span> = 2.5  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">dollar/min/m**3</span>
<span style="color: #BA36A5;">y_value</span>  = 1.5 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">dollar / mol</span>

<span style="color: #BA36A5;">Cx0</span> = 2.5 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">kmol / m**3</span>
<span style="color: #BA36A5;">v0</span> = 12.0 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">m**3 / min</span>

<span style="color: #BA36A5;">k</span> = 30.0 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">1/min</span>
</pre>
</div>

<p>
To compute the profit as a function of reactor volume, we need to compute how much Y is produced, then multiply that by the value of Y and subtract the operating cost. To compute how much Y is produced, we use a mole balance on X and Y, and integrate it to the volume to get the molar flows of X and Y. I like to write mole balances like this.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">def</span> <span style="color: #006699;">dFdV</span>(V, F):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #036A07;">'PFR mole balances on X and Y.'</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">Fx</span>, <span style="color: #BA36A5;">Fy</span> = F
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">Cx</span> = Fx / v0
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">rx</span> = -k * Cx
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">ry</span> = -rx

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">dFdX</span> = rx
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">dFdY</span> = ry
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> [dFdX, dFdY]

<span style="color: #BA36A5;">F0</span> = [Cx0 * v0,  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Fx0</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> 0.0]       <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Fy0</span>
</pre>
</div>

<p>
Now, we can write a profit function. It will take a V as the argument, integrate the PFR to that volume to find the molar exit flow rates, and then compute the profit.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
<span style="color: #0000FF;">from</span> scipy.integrate <span style="color: #0000FF;">import</span> solve_ivp

<span style="color: #0000FF;">def</span> <span style="color: #006699;">profit</span>(V, sign=1):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">Vspan</span> = (0, V)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">sol</span> = solve_ivp(dFdV, Vspan, F0)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">Fx</span>, <span style="color: #BA36A5;">Fy</span> = sol.y
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">Fy_exit</span> = Fy[-1]
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> sign * (Fy_exit * y_value - cost * V)
</pre>
</div>

<p>
It is always a good idea to plot the profit function. We use a list comprehension here because the profit function is not <i>vectorized</i>, which means we cannot pass an array of volumes in and get an array of profits out.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #BA36A5;">Vspan</span> = np.linspace(0, 4)
<span style="color: #BA36A5;">profit_array</span> = [profit(V) <span style="color: #0000FF;">for</span> V <span style="color: #0000FF;">in</span> Vspan]

%matplotlib inline
<span style="color: #0000FF;">import</span> matplotlib.pyplot <span style="color: #0000FF;">as</span> plt
plt.plot(Vspan, profit_array)
plt.xlabel(<span style="color: #008000;">'V'</span>)
plt.ylabel(<span style="color: #008000;">'profit'</span>)
</pre>
</div>

<pre class="example">
Text(0, 0.5, 'profit')
</pre>


<pre class="example">
&lt;Figure size 432x288 with 1 Axes&gt;
</pre>



<div class="figure">
<p><img src="obipy-resources/c32ed400013180969dbb2fb32c999750492e428a/6c5a9dcdf0a65dad49b6852a44a46e4935632908.png" alt="6c5a9dcdf0a65dad49b6852a44a46e4935632908.png" />
</p>
</div>

<p>
You can see from this plot there is a maximum near V=1.5. We can use that as a guess for fmin.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">from</span> scipy.optimize <span style="color: #0000FF;">import</span> fmin
<span style="color: #BA36A5;">sol</span> = minimize(profit, 1.5, args=(-1,))

<span style="color: #0000FF;">print</span>(f<span style="color: #008000;">'The optimal volume is </span><span style="color: #BA36A5;">{sol.x[0]:1.2f}</span><span style="color: #008000;"> m^3 with a profit of $</span><span style="color: #BA36A5;">{profit(sol.x[0]):1.2f}</span><span style="color: #008000;">.'</span>)
</pre>
</div>

<p>
The optimal volume is 1.52 m^3 with a profit of $40.19.
</p>


<p>
This problem highlights the opportunities we have to integrate many ideas together to solve complex problems. We have integration of an ODE, nonlinear algebra/minimization, with graphical estimates of the solution.
</p>

<p>
<b>Challenge</b> Can you solve this with an event and solve_ivp?
</p>
</div>
</div>
</div>

<div id="outline-container-orgcb14ac9" class="outline-2">
<h2 id="orgcb14ac9"><span class="section-number-2">3</span> Summary</h2>
<div class="outline-text-2" id="text-3">
<p>
Today we introduced the concept of finding minima/maxima in functions. This is an iterative process, much like finding the roots of a nonlinear function. You can think of it as finding the zeros of the derivative of a nonlinear function! This method is the root of many important optimization problems including regression.
</p>

<p>
<code>scipy.optimize.minimize</code> is the preferred function for doing minimization. There are other more specific ones described at <a href="https://docs.scipy.org/doc/scipy/reference/optimize.html">https://docs.scipy.org/doc/scipy/reference/optimize.html</a>, but <code>minimize</code> has a more consistent interface and provides almost all the functionality of those other methods.
</p>

<p>
Next time, we will look at how to apply minimization to regression problems.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: John Kitchin</p>
<p class="date">Created: 2020-03-31 Tue 07:32</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
